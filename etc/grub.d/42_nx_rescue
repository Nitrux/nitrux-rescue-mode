#!/bin/sh

# SPDX-License-Identifier: BSD-3-Clause
# Copyright 2026 <Nitrux Latinoamericana S.C. <hello@nxos.org>>

pick_pair() {
  find /boot -maxdepth 1 -type f -name 'vmlinuz-*' -print \
    | sort -V -r \
    | while IFS= read -r k; do
        v="${k##*/vmlinuz-}"
        i="/boot/initrd.img-$v"
        if [ -f "$i" ]; then
          printf '%s|%s\n' "$k" "$i"
          return 0
        fi
      done
  return 1
}

pair="$(pick_pair || true)"
[ -n "$pair" ] || exit 0

VMLINUX="${pair%%|*}"
INITRD="${pair##*|}"

cat <<EOF
menuentry 'Enter Rescue Mode (Restore NUTS Backup)' --class nitrux --class gnu-linux --class gnu --class os {
    insmod part_gpt
    insmod xfs
    search --no-floppy --label --set=root NX_ROOT
    echo 'Loading Rescue Mode...'
    linux $VMLINUX root=LABEL=NX_ROOT ro nx_rescue=1
    initrd $INITRD
}
EOF
